{% extends "base.html" %}

{% block title %}Gestión de Profesores - UEIPAB{% endblock %}

{% block extra_css %}
<style>
    .main-container {
        background: rgba(30, 30, 45, 0.95);
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 30px;
    }
    
    .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 20px;
        text-align: center;
        margin-bottom: 30px;
    }
    
    .form-section {
        background: rgba(40, 40, 60, 0.8);
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .form-control, .form-select {
        background: rgba(50, 50, 70, 0.8);
        border: 2px solid rgba(255, 255, 255, 0.2);
        color: #e0e0e0;
        border-radius: 10px;
        padding: 12px;
    }
    
    .form-control:focus, .form-select:focus {
        background: rgba(60, 60, 80, 0.9);
        border-color: #667eea;
        color: #ffffff;
    }
    
    .form-label {
        color: #e0e0e0;
        font-weight: 600;
        margin-bottom: 8px;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 10px;
        padding: 12px 30px;
        font-weight: 600;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    .btn-success {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border: none;
        border-radius: 10px;
        padding: 10px 20px;
    }
    
    .btn-danger {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        border: none;
        border-radius: 10px;
        padding: 10px 20px;
    }
    
    .btn-info {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        border: none;
        border-radius: 10px;
        padding: 10px 20px;
    }
    
    .profesor-card {
        background: rgba(40, 40, 60, 0.8);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: transform 0.3s;
    }
    
    .profesor-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
    }
    
    .profesor-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .profesor-info h5 {
        color: #667eea;
        margin-bottom: 5px;
    }
    
    .profesor-info p {
        color: #e0e0e0;
        margin: 0;
        font-size: 0.9em;
    }
    
    .secciones-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
    }
    
    .seccion-badge {
        background: rgba(102, 126, 234, 0.2);
        border: 1px solid #667eea;
        color: #e0e0e0;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.85em;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .seccion-badge button {
        background: none;
        border: none;
        color: #ff6b9d;
        cursor: pointer;
        padding: 0;
        margin-left: 5px;
    }
    
    .badge {
        padding: 5px 10px;
        border-radius: 5px;
    }
    
    .modal-content {
        background: rgba(30, 30, 45, 0.98);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #e0e0e0;
    }
    
    .modal-header {
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .modal-footer {
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .checkbox-group {
        max-height: 300px;
        overflow-y: auto;
        background: rgba(50, 50, 70, 0.6);
        border-radius: 10px;
        padding: 15px;
    }
    
    .form-check-label {
        color: #e0e0e0;
    }
</style>
{% endblock %}

{% block content %}
<div class="main-container">
    <div class="header">
        <h1><i class="fas fa-users-cog"></i> Gestión de Usuarios</h1>
        <p class="mb-0">Administración de usuarios, roles y asignación de secciones</p>
    </div>
    
    <!-- Formulario para crear usuario -->
    <div class="form-section">
        <h4 class="mb-4"><i class="fas fa-user-plus"></i> Crear Nuevo Usuario</h4>
        <form id="profesorForm">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="nombre" class="form-label">Nombre</label>
                    <input type="text" class="form-control" id="nombre" required>
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="apellido" class="form-label">Apellido</label>
                    <input type="text" class="form-control" id="apellido" required>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="email" class="form-label">Correo Electrónico</label>
                    <input type="email" class="form-control" id="email" required>
                </div>
                
                <div class="col-md-4 mb-3">
                    <label for="password" class="form-label">Contraseña</label>
                    <input type="password" class="form-control" id="password" required>
                </div>
                
                <div class="col-md-4 mb-3">
                    <label for="rol" class="form-label">Rol</label>
                    <select class="form-select" id="rol" required>
                        <option value="profesor">Profesor</option>
                        <option value="administrador">Administrador</option>
                    </select>
                </div>
            </div>
            
            <div class="text-center">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Crear Usuario
                </button>
            </div>
        </form>
    </div>
    
    <!-- Lista de usuarios -->
    <div class="form-section">
        <h4 class="mb-4"><i class="fas fa-list"></i> Usuarios Registrados</h4>
        <div id="profesoresList">
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para asignar secciones -->
<div class="modal fade" id="asignarSeccionesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus-circle"></i> Asignar Secciones
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="profesorNombre" class="mb-3"></p>
                
                <div class="mb-3">
                    <label class="form-label">Filtrar por Etapa:</label>
                    <select class="form-select" id="etapaFiltro">
                        <option value="">Todas las etapas</option>
                        <option value="Maternal">Maternal</option>
                        <option value="Primaria">Primaria</option>
                        <option value="Secundaria">Secundaria</option>
                    </select>
                </div>
                
                <div class="checkbox-group" id="seccionesCheckboxes">
                    <!-- Se llenará dinámicamente -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarAsignaciones()">
                    <i class="fas fa-save"></i> Guardar Asignaciones
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let profesores = [];
    let usuarios = [];
    let secciones = [];
    let profesorSeleccionado = null;
    
    $(document).ready(function() {
        cargarUsuarios();
        cargarSecciones();
        
        $('#profesorForm').submit(function(e) {
            e.preventDefault();
            crearProfesor();
        });
        
        $('#etapaFiltro').change(function() {
            mostrarSeccionesCheckboxes();
        });
    });
    
    function cargarSecciones() {
        $.ajax({
            url: BASE_URL + '/secciones',
            method: 'GET',
            success: function(data) {
                secciones = data;
            }
        });
    }
    
    function crearProfesor() {
        const data = {
            nombre: $('#nombre').val().trim(),
            apellido: $('#apellido').val().trim(),
            email: $('#email').val().trim(),
            contraseña: $('#password').val(),
            rol: $('#rol').val()
        };
        
        $.ajax({
            url: BASE_URL + '/api/usuario',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                const rolCreado = data.rol === 'profesor' ? 'Profesor' : 'Administrador';
                alert(`✅ ${rolCreado} creado correctamente`);
                $('#profesorForm')[0].reset();
                cargarUsuarios();
            },
            error: function(xhr) {
                const error = xhr.responseJSON?.error || 'Error al crear el usuario';
                alert('❌ ' + error);
            }
        });
    }
    
    function cargarUsuarios() {
        // Cargar todos los usuarios
        $.ajax({
            url: BASE_URL + '/api/usuarios',
            method: 'GET',
            success: function(data) {
                usuarios = data;
                // Cargar asignaciones de profesores
                $.ajax({
                    url: BASE_URL + '/api/profesores/asignaciones',
                    method: 'GET',
                    success: function(asignaciones) {
                        profesores = asignaciones;
                        mostrarUsuarios();
                    }
                });
            },
            error: function() {
                $('#profesoresList').html('<div class="alert alert-danger">Error al cargar usuarios</div>');
            }
        });
    }
    
    function mostrarUsuarios() {
        const container = $('#profesoresList');
        container.empty();
        
        if (usuarios.length === 0) {
            container.html('<div class="alert alert-info">No hay usuarios registrados</div>');
            return;
        }
        
        usuarios.forEach(function(usuario) {
            // Buscar asignaciones si es profesor
            const profesor = profesores.find(p => p.id === usuario.id);
            const seccionesHTML = profesor && profesor.secciones && profesor.secciones.length > 0
                ? profesor.secciones.map(s => `
                    <span class="seccion-badge">
                        <i class="fas fa-chalkboard"></i>
                        ${s.etapa} - ${s.seccion}
                        <button onclick="desasignarSeccion(${usuario.id}, ${s.id})" title="Quitar">
                            <i class="fas fa-times"></i>
                        </button>
                    </span>
                `).join('')
                : usuario.rol === 'profesor' ? '<span class="text-muted"><i>Sin secciones asignadas</i></span>' : '<span class="text-muted"><i>Los administradores no tienen secciones</i></span>';
            
            const rolBadgeClass = usuario.rol === 'administrador' ? 'bg-danger' : 'bg-info';
            const rolTexto = usuario.rol === 'administrador' ? 'Administrador' : 'Profesor';
            const nuevoRol = usuario.rol === 'administrador' ? 'profesor' : 'administrador';
            const nuevoRolTexto = usuario.rol === 'administrador' ? 'Profesor' : 'Administrador';
            const seccionesCount = profesor && profesor.secciones ? profesor.secciones.length : 0;
            
            container.append(`
                <div class="profesor-card">
                    <div class="profesor-header">
                        <div class="profesor-info">
                            <h5><i class="fas fa-user"></i> ${usuario.nombre} ${usuario.apellido}</h5>
                            <p><i class="fas fa-envelope"></i> ${usuario.email}</p>
                            <p>
                                <span class="badge ${rolBadgeClass}">${rolTexto}</span>
                                ${usuario.rol === 'profesor' ? `<span class="badge bg-secondary ms-2">${seccionesCount} sección(es)</span>` : ''}
                            </p>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-warning me-2" onclick="cambiarRol(${usuario.id}, '${nuevoRol}', '${usuario.nombre}', '${usuario.apellido}', '${nuevoRolTexto}')" title="Cambiar a ${nuevoRolTexto}">
                                <i class="fas fa-exchange-alt"></i> Cambiar a ${nuevoRolTexto}
                            </button>
                            ${usuario.rol === 'profesor' ? `
                            <button class="btn btn-sm btn-success me-2" onclick="abrirModalAsignar(${usuario.id})">
                                <i class="fas fa-plus"></i> Asignar Secciones
                            </button>
                            ` : ''}
                            <button class="btn btn-sm btn-danger" onclick="eliminarProfesor(${usuario.id})">
                                <i class="fas fa-trash"></i> Eliminar
                            </button>
                        </div>
                    </div>
                    ${usuario.rol === 'profesor' ? `
                    <div class="secciones-list">
                        ${seccionesHTML}
                    </div>
                    ` : ''}
                </div>
            `);
        });
    }
    
    function abrirModalAsignar(profesorId) {
        const profesor = profesores.find(p => p.id === profesorId);
        if (!profesor) return;
        
        profesorSeleccionado = profesor;
        $('#profesorNombre').html(`<strong>Profesor:</strong> ${profesor.nombre} ${profesor.apellido}`);
        $('#etapaFiltro').val('');
        
        mostrarSeccionesCheckboxes();
        
        const modal = new bootstrap.Modal(document.getElementById('asignarSeccionesModal'));
        modal.show();
    }
    
    function mostrarSeccionesCheckboxes() {
        const container = $('#seccionesCheckboxes');
        container.empty();
        
        const etapaFiltro = $('#etapaFiltro').val();
        const seccionesFiltradas = etapaFiltro 
            ? secciones.filter(s => s.etapa === etapaFiltro)
            : secciones;
        
        if (seccionesFiltradas.length === 0) {
            container.append('<p class="text-center">No hay secciones disponibles</p>');
            return;
        }
        
        const seccionesAsignadas = profesorSeleccionado.secciones.map(s => s.id);
        
        seccionesFiltradas.forEach(function(seccion) {
            const checked = seccionesAsignadas.includes(seccion.id_seccion) ? 'checked' : '';
            container.append(`
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" value="${seccion.id_seccion}" 
                           id="seccion_${seccion.id_seccion}" ${checked}>
                    <label class="form-check-label" for="seccion_${seccion.id_seccion}">
                        <strong>${seccion.etapa}</strong> - ${seccion.nombre_seccion}
                        <small class="text-muted">(H: ${seccion.matricula_h}, M: ${seccion.matricula_m})</small>
                    </label>
                </div>
            `);
        });
    }
    
    function guardarAsignaciones() {
        const seccionesSeleccionadas = [];
        $('#seccionesCheckboxes input:checked').each(function() {
            seccionesSeleccionadas.push(parseInt($(this).val()));
        });
        
        if (seccionesSeleccionadas.length === 0) {
            alert('Por favor seleccione al menos una sección');
            return;
        }
        
        $.ajax({
            url: BASE_URL + '/api/profesor/asignar-secciones',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                profesor_id: profesorSeleccionado.id,
                secciones: seccionesSeleccionadas
            }),
            success: function(response) {
                alert('✅ ' + response.message);
                bootstrap.Modal.getInstance(document.getElementById('asignarSeccionesModal')).hide();
                cargarUsuarios();
            },
            error: function(xhr) {
                const error = xhr.responseJSON?.error || 'Error al asignar secciones';
                alert('❌ ' + error);
            }
        });
    }
    
    function desasignarSeccion(profesorId, seccionId) {
        if (!confirm('¿Está seguro de quitar esta sección del profesor?')) return;
        
        $.ajax({
            url: BASE_URL + `/api/profesor/${profesorId}/seccion/${seccionId}`,
            method: 'DELETE',
            success: function(response) {
                alert('✅ ' + response.message);
                cargarUsuarios();
            },
            error: function(xhr) {
                const error = xhr.responseJSON?.error || 'Error al desasignar la sección';
                alert('❌ ' + error);
            }
        });
    }
    
    function eliminarProfesor(profesorId) {
        const profesor = profesores.find(p => p.id === profesorId);
        if (!profesor) {
            alert('❌ Profesor no encontrado');
            return;
        }
        
        if (!confirm(`¿Está seguro de eliminar al profesor ${profesor.nombre} ${profesor.apellido}?\n\nEsta acción eliminará también todas sus asignaciones de secciones.`)) return;
        
        $.ajax({
            url: BASE_URL + `/api/profesor/${profesorId}`,
            method: 'DELETE',
            success: function(response) {
                alert('✅ ' + response.message);
                cargarUsuarios();
            },
            error: function(xhr) {
                const error = xhr.responseJSON?.error || 'Error al eliminar el usuario';
                alert('❌ ' + error);
            }
        });
    }
    
    function cambiarRol(usuarioId, nuevoRol, nombre, apellido, nuevoRolTexto) {
        if (!confirm(`¿Está seguro de cambiar el rol de ${nombre} ${apellido} a ${nuevoRolTexto}?`)) return;
        
        $.ajax({
            url: BASE_URL + `/api/usuario/${usuarioId}/rol`,
            method: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify({ rol: nuevoRol }),
            success: function(response) {
                alert('✅ ' + response.message);
                cargarUsuarios();
            },
            error: function(xhr) {
                const error = xhr.responseJSON?.error || 'Error al cambiar el rol';
                alert('❌ ' + error);
            }
        });
    }
</script>
{% endblock %}
