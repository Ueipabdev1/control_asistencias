<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gestión de Matrícula - Control de Asistencias</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #e0e0e0;
        }
        
        .main-container {
            padding: 15px;
            max-width: 100%;
            margin: 0 auto;
            overflow-x: hidden;
        }

        @media (min-width: 1400px) {
            .main-container {
                padding: 30px;
                max-width: 1400px;
            }
        }
        
        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        @media (min-width: 768px) {
            .header {
                padding: 30px;
                margin-bottom: 30px;
                border-radius: 20px;
            }
        }
        
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .card-header {
            background: rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px 15px 0 0 !important;
        }
        
        .table-responsive {
            margin: 0 -15px;
            padding: 0 15px;
            border-radius: 10px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .table {
            color: #e0e0e0;
            min-width: 1000px;
            margin-bottom: 1rem;
        }

        .table th, .table td {
            white-space: nowrap;
            padding: 0.75rem;
            vertical-align: middle;
            border-color: rgba(255, 255, 255, 0.1);
            color: #e0e0e0;
        }

        .table th {
            background: rgba(102, 126, 234, 0.2);
            border-color: rgba(255, 255, 255, 0.2);
            color: #ffffff;
            font-weight: 500;
        }

        @media (max-width: 767px) {
            .table th, .table td {
                padding: 0.5rem;
                font-size: 0.875rem;
            }
            
            .table .btn {
                padding: 0.25rem 0.5rem;
                font-size: 0.8rem;
            }
            
            .table .badge {
                font-size: 0.75rem;
                padding: 0.25em 0.5em;
            }
        }
        
        .table th {
            background: rgba(102, 126, 234, 0.2);
            border-color: rgba(255, 255, 255, 0.2);
            color: #ffffff;
        }
        
        .table td {
            border-color: rgba(255, 255, 255, 0.1);
        }
        
        .form-label {
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .form-control, .form-select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #e0e0e0;
            padding: 0.5rem 0.75rem;
            height: auto;
        }

        .form-control:focus, .form-select:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: #667eea;
            color: #e0e0e0;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .form-control::placeholder {
            color: rgba(255, 255, 255, 0.5);
            opacity: 1;
        }
        
        .form-control:focus, .form-select:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: #667eea;
            color: #e0e0e0;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .btn {
            border: none;
            border-radius: 10px;
            padding: 0.5rem 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .btn i {
            margin-right: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #c82333);
            border: none;
            color: white;
            transition: all 0.3s ease;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .alert {
            border-radius: 10px;
            border: none;
            padding: 1rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .alert-dismissible .btn-close {
            padding: 1rem;
        }

        /* Responsive adjustments */
        @media (max-width: 767px) {
            .btn {
                width: 100%;
                margin-bottom: 0.5rem;
            }
            
            .btn-group .btn {
                width: auto;
                margin-bottom: 0;
            }
            
            .form-group {
                margin-bottom: 1rem;
            }
            
            .card-header h4 {
                font-size: 1.25rem;
            }
        }

        /* Print styles */
        @media print {
            .no-print {
                display: none !important;
            }
            
            .card {
                border: none !important;
                background: transparent !important;
                box-shadow: none !important;
            }
            
            .table {
                color: #000 !important;
            }
            
            .table th {
                color: #000 !important;
                background: #f8f9fa !important;
                border-color: #dee2e6 !important;
            }
            
            .table td {
                border-color: #dee2e6 !important;
            }
            
            .card-header {
                background: transparent !important;
                border-bottom: 1px solid #dee2e6 !important;
            }
            
            h1, h2, h3, h4, h5, h6 {
                color: #000 !important;
            }
        }
        
        .alert-success {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
            border: 1px solid rgba(40, 167, 69, 0.3);
        }
        
        .alert-warning {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }
        
        .alert-danger {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
            border: 1px solid rgba(220, 53, 69, 0.3);
        }
        
        .form-label {
            color: #e0e0e0;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .badge {
            font-size: 0.8em;
            padding: 8px 12px;
            border-radius: 20px;
        }
        
        .input-group-text {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #e0e0e0;
        }
        
        h1, h2, h3, h4, h5, h6 {
            color: #ffffff;
            margin-bottom: 1rem;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container-fluid p-0">
        <div class="main-container">
            <!-- Mobile Menu Toggle -->
            <div class="d-md-none mb-3">
                <button class="btn btn-primary w-100" type="button" data-bs-toggle="collapse" data-bs-target="#mobileMenu">
                    <i class="fas fa-bars me-2"></i> Menú
                </button>
                <div class="collapse mt-2" id="mobileMenu">
                    <div class="card card-body bg-dark">
                        <a href="/admin_dashboard" class="btn btn-outline-light mb-2"><i class="fas fa-arrow-left me-2"></i>Volver al Dashboard</a>
                        <a href="/" class="btn btn-outline-light"><i class="fas fa-home me-2"></i> Inicio</a>
                    </div>
                </div>
            </div>

            <div class="header">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
                    <div class="mb-3 mb-md-0">
                        <h1 class="h3 mb-1"><i class="fas fa-users me-2"></i>Gestión de Matrícula</h1>
                        <p class="mb-0 small d-none d-md-block">Administración de estudiantes matriculados</p>
                    </div>
                    <div class="d-none d-md-block">
                        <a href="/admin_dashboard" class="btn btn-outline-light" data-bs-toggle="tooltip" title="Volver al Dashboard">
                            <i class="fas fa-arrow-left"></i>
                        </a>
                        <a href="/" class="btn btn-outline-light ms-2" data-bs-toggle="tooltip" title="Inicio">
                            <i class="fas fa-home"></i>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Formulario de Matrícula -->
            <div class="card mb-4">
                <div class="card-header bg-dark bg-opacity-25">
                    <h4 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Gestionar Matrícula por Sección</h4>
                </div>
                <div class="card-body">
                    <form id="matriculaForm">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label"><i class="fas fa-graduation-cap"></i> Etapa Educativa:</label>
                                <select id="etapa" class="form-select" required>
                                    <option value="">Seleccionar etapa</option>
                                    <option value="Maternal">Maternal</option>
                                    <option value="Primaria">Primaria</option>
                                    <option value="Secundaria">Secundaria</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label"><i class="fas fa-chalkboard-teacher"></i> Sección:</label>
                                <select id="seccion" class="form-select" required>
                                    <option value="">Seleccionar sección</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label class="form-label"><i class="fas fa-mars text-info"></i> Estudiantes Masculinos:</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-male"></i></span>
                                    <input type="number" id="estudiantesMasculinos" class="form-control" min="0" value="0" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label"><i class="fas fa-venus text-danger"></i> Estudiantes Femeninas:</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-female"></i></span>
                                    <input type="number" id="estudiantesFemeninas" class="form-control" min="0" value="0" required>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <h5>Total de Estudiantes</h5>
                                        <h2 id="totalEstudiantes" class="text-primary">0</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <h5>Distribución por Género</h5>
                                        <div id="distribucionGenero">
                                            <span class="badge bg-info me-2">♂ 0%</span>
                                            <span class="badge bg-danger">♀ 0%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <button type="submit" class="btn btn-success w-100">
                                    <i class="fas fa-save"></i> Guardar Matrícula
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button type="button" id="limpiarForm" class="btn btn-warning w-100">
                                    <i class="fas fa-broom"></i> Limpiar Formulario
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Tabla de Matrículas -->
            <div class="card">
                <div class="card-header d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center bg-dark bg-opacity-25">
                    <h4 class="mb-3 mb-md-0"><i class="fas fa-table me-2"></i>Matrículas Registradas</h4>
                    <div class="d-flex flex-column flex-md-row w-100 w-md-auto">
                        <button id="actualizarTabla" class="btn btn-primary mb-2 mb-md-0 me-md-2">
                            <i class="fas fa-sync-alt me-1"></i> Actualizar
                        </button>
                        <button class="btn btn-outline-light d-print-none" onclick="window.print()">
                            <i class="fas fa-print me-1"></i> Imprimir
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th class="text-center">ID</th>
                                    <th>Sección</th>
                                    <th class="text-center">Hombres</th>
                                    <th class="text-center">Mujeres</th>
                                    <th class="text-center">Total</th>
                                    <th class="text-center no-print">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaMatriculas" class="table-group-divider">
                                <!-- Se llenará dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Alertas -->
            <div id="alertas"></div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize tooltips and touch controls
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Bootstrap tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function(tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            // Make tables more touch-friendly on mobile
            function setupTableTouchControls(table) {
                if (!table) return;
                
                let isDown = false;
                let startX;
                let scrollLeft;
                
                function handleMouseDown(e) {
                    isDown = true;
                    startX = e.pageX - table.offsetLeft;
                    scrollLeft = table.scrollLeft;
                    table.style.cursor = 'grabbing';
                }
                
                function handleMouseLeave() {
                    isDown = false;
                    table.style.cursor = 'grab';
                }
                
                function handleMouseUp() {
                    isDown = false;
                    table.style.cursor = 'grab';
                }
                
                function handleMouseMove(e) {
                    if (!isDown) return;
                    e.preventDefault();
                    const x = e.pageX - table.offsetLeft;
                    const walk = (x - startX) * 2; // Adjust scroll speed
                    table.scrollLeft = scrollLeft - walk;
                }

                // Add event listeners
                table.addEventListener('mousedown', handleMouseDown);
                table.addEventListener('mouseleave', handleMouseLeave);
                table.addEventListener('mouseup', handleMouseUp);
                table.addEventListener('mousemove', handleMouseMove);
                
                // Prevent scrolling the page when swiping on the table
                table.addEventListener('touchmove', function(e) {
                    if (table.scrollWidth > table.clientWidth) {
                        e.preventDefault();
                    }
                }, { passive: false });
            }
            
            // Initialize touch controls for all tables
            document.querySelectorAll('.table-responsive').forEach(setupTableTouchControls);
            
            // Auto-hide alerts after 5 seconds
            setTimeout(function() {
                var alerts = document.querySelectorAll('.alert');
                alerts.forEach(function(alert) {
                    var bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                });
            }, 5000);
        });
    </script>
    <script>
        let matriculaEditando = null;

        $(document).ready(function() {
            cargarSecciones();
            cargarMatriculas();
            
            // Event listeners
            $('#etapa').change(function() {
                cargarSeccionesPorEtapa($(this).val());
            });
            
            $('#estudiantesMasculinos, #estudiantesFemeninas').on('input', function() {
                actualizarTotales();
            });
            
            $('#matriculaForm').submit(function(e) {
                e.preventDefault();
                guardarMatricula();
            });
            
            $('#limpiarForm').click(function() {
                limpiarFormulario();
            });
            
            $('#actualizarTabla').click(function() {
                cargarMatriculas();
            });
        });

        function cargarSecciones() {
            const secciones = {
                'Maternal': ['Nivel 1 maternal', 'Nivel 2 maternal', 'Nivel 3 maternal'],
                'Primaria': ['1er grado primaria', '2do grado primaria', '3er grado primaria', '4to grado primaria', '5to grado primaria', '6to grado primaria'],
                'Secundaria': ['1er año secundaria', '2do año secundaria', '3er año A secundaria', '3er año B secundaria', '4to año secundaria', '5to año secundaria']
            };
            
            window.seccionesPorEtapa = secciones;
        }

        function cargarSeccionesPorEtapa(etapa) {
            const selectSeccion = $('#seccion');
            selectSeccion.empty();
            selectSeccion.append('<option value="">Seleccionar sección</option>');
            
            if (etapa && window.seccionesPorEtapa[etapa]) {
                window.seccionesPorEtapa[etapa].forEach(seccion => {
                    selectSeccion.append(`<option value="${seccion}">${seccion}</option>`);
                });
            }
        }

        function actualizarTotales() {
            const masculinos = parseInt($('#estudiantesMasculinos').val()) || 0;
            const femeninas = parseInt($('#estudiantesFemeninas').val()) || 0;
            const total = masculinos + femeninas;
            
            $('#totalEstudiantes').text(total);
            
            if (total > 0) {
                const porcMasculinos = Math.round((masculinos / total) * 100);
                const porcFemeninas = Math.round((femeninas / total) * 100);
                
                $('#distribucionGenero').html(`
                    <span class="badge bg-info me-2">♂ ${porcMasculinos}%</span>
                    <span class="badge bg-danger">♀ ${porcFemeninas}%</span>
                `);
            } else {
                $('#distribucionGenero').html(`
                    <span class="badge bg-info me-2">♂ 0%</span>
                    <span class="badge bg-danger">♀ 0%</span>
                `);
            }
        }

        function guardarMatricula() {
            const etapa = $('#etapa').val();
            const seccion = $('#seccion').val();
            const estudiantesMasculinos = parseInt($('#estudiantesMasculinos').val()) || 0;
            const estudiantesFemeninos = parseInt($('#estudiantesFemeninas').val()) || 0;

            if (!etapa || !seccion) {
                mostrarAlerta('Por favor complete todos los campos obligatorios', 'warning');
                return;
            }

            const data = {
                etapa: etapa,
                seccion: seccion,
                num_estudiantes_h: estudiantesMasculinos,
                num_estudiantes_m: estudiantesFemeninos
            };

            const url = matriculaEditando ? `/api/matricula/${matriculaEditando}` : '/api/matricula';
            const method = matriculaEditando ? 'PUT' : 'POST';

            $.ajax({
                url: url,
                method: method,
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    mostrarAlerta(matriculaEditando ? 'Matrícula actualizada correctamente' : 'Matrícula guardada correctamente', 'success');
                    limpiarFormulario();
                    cargarMatriculas();
                },
                error: function(xhr) {
                    const error = xhr.responseJSON ? xhr.responseJSON.error : 'Error al guardar la matrícula';
                    mostrarAlerta(error, 'danger');
                }
            });
        }

        function cargarMatriculas() {
            $.ajax({
                url: '/api/matriculas',
                method: 'GET',
                success: function(data) {
                    let html = '';
                    data.forEach(function(matricula) {
                        const total = matricula.num_estudiantes_h + matricula.num_estudiantes_m;
                        const porcentajeMasculino = total > 0 ? Math.round((matricula.num_estudiantes_h / total) * 100) : 0;
                        const porcentajeFemenino = total > 0 ? Math.round((matricula.num_estudiantes_m / total) * 100) : 0;
                        
                        html += `
                            <tr>
                                <td><span class="badge bg-primary">${matricula.etapa_nombre}</span></td>
                                <td><strong>${matricula.seccion_nombre}</strong></td>
                                <td class="text-info"><strong>${matricula.num_estudiantes_h}</strong></td>
                                <td class="text-danger"><strong>${matricula.num_estudiantes_m}</strong></td>
                                <td class="text-success"><strong>${total}</strong></td>
                                <td>
                                    <span class="badge bg-info me-1">♂ ${porcentajeMasculino}%</span>
                                    <span class="badge bg-danger">♀ ${porcentajeFemenino}%</span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-warning me-1" onclick="editarMatricula(${matricula.id})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="eliminarMatricula(${matricula.id})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    $('#tablaMatriculas').html(html);
                },
                error: function() {
                    mostrarAlerta('Error al cargar las matrículas', 'danger');
                }
            });
        }

        function editarMatricula(id) {
            $.ajax({
                url: `/api/matricula/${id}`,
                method: 'GET',
                success: function(matricula) {
                    matriculaEditando = id;
                    
                    $('#etapa').val(matricula.etapa);
                    cargarSeccionesPorEtapa(matricula.etapa);
                    
                    setTimeout(() => {
                        $('#seccion').val(matricula.seccion);
                        $('#estudiantesMasculinos').val(matricula.num_estudiantes_h);
                        $('#estudiantesFemeninas').val(matricula.num_estudiantes_m);
                        actualizarTotales();
                    }, 100);
                    
                    mostrarAlerta('Matrícula cargada para edición', 'success');
                },
                error: function() {
                    mostrarAlerta('Error al cargar la matrícula para edición', 'danger');
                }
            });
        }

        function eliminarMatricula(id) {
            if (confirm('¿Estás seguro de que deseas eliminar esta matrícula?')) {
                $.ajax({
                    url: `/api/matricula/${id}`,
                    method: 'DELETE',
                    success: function() {
                        mostrarAlerta('Matrícula eliminada correctamente', 'success');
                        cargarMatriculas();
                    },
                    error: function() {
                        mostrarAlerta('Error al eliminar la matrícula', 'danger');
                    }
                });
            }
        }

        function limpiarFormulario() {
            $('#etapa').val('');
            $('#seccion').val('').prop('disabled', true);
            $('#estudiantesMasculinos').val('0');
            $('#estudiantesFemeninas').val('0');
            actualizarTotales();
            matriculaEditando = null;
            $('#btnGuardar').text('Guardar Matrícula').removeClass('btn-warning').addClass('btn-success');
        }

        function mostrarAlerta(mensaje, tipo) {
            const alerta = `
                <div class="alert alert-${tipo} alert-dismissible fade show" role="alert">
                    <i class="fas fa-info-circle"></i> ${mensaje}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" style="filter: invert(1);"></button>
                </div>
            `;
            $('#alertas').html(alerta);
            
            setTimeout(function() {
                $('.alert').fadeOut();
            }, 5000);
        }
    </script>
</body>
</html>
