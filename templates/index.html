{% extends "base.html" %}

{% block title %}Control de Asistencias - UEIPAB{% endblock %}

{% block extra_css %}
<style>
    .main-container {
        background: rgba(30, 30, 45, 0.95);
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 20px 20px 0 0;
        text-align: center;
    }
    
    .form-section {
        background: rgba(40, 40, 60, 0.8);
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        margin: 30px;
        padding: 40px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .form-group {
        margin-bottom: 25px;
    }
    
    .form-label {
        font-weight: 600;
        color: #e0e0e0;
        margin-bottom: 10px;
        display: block;
    }
    
    .form-control {
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 15px;
        padding: 15px 20px;
        font-size: 16px;
        transition: all 0.3s ease;
        background: rgba(50, 50, 70, 0.8);
        color: #e0e0e0;
    }
    
    .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        background: rgba(60, 60, 80, 0.9);
        color: #ffffff;
    }
    
    .form-control option {
        background: #2a2a40;
        color: #e0e0e0;
    }
    
    /* Lista de estudiantes */
    .estudiantes-container {
        display: none;
        margin-top: 30px;
    }
    
    .estudiantes-container.show {
        display: block;
    }
    
    .estudiante-item {
        background: rgba(50, 50, 70, 0.6);
        border-radius: 10px;
        padding: 15px 20px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }
    
    .estudiante-item:hover {
        background: rgba(60, 60, 80, 0.8);
        transform: translateX(5px);
    }
    
    .estudiante-item.presente {
        border-color: #28a745;
        background: rgba(40, 167, 69, 0.2);
    }
    
    .estudiante-info {
        display: flex;
        align-items: center;
        gap: 15px;
        flex: 1;
    }
    
    .estudiante-genero {
        font-size: 1.5em;
        width: 30px;
    }
    
    .estudiante-nombre {
        font-weight: 600;
        color: #e0e0e0;
        font-size: 1.1em;
    }
    
    .estudiante-cedula {
        color: #a0a0a0;
        font-size: 0.9em;
        margin-left: 10px;
    }
    
    .estudiante-checkbox {
        width: 30px;
        height: 30px;
        cursor: pointer;
        accent-color: #667eea;
    }
    
    /* Contadores de asistencia */
    .contadores-asistencia {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .contador-card {
        background: rgba(50, 50, 70, 0.8);
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        border: 2px solid rgba(255, 255, 255, 0.1);
    }
    
    .contador-card.masculino {
        border-color: rgba(79, 195, 247, 0.5);
    }
    
    .contador-card.femenino {
        border-color: rgba(244, 143, 177, 0.5);
    }
    
    .contador-card.total {
        border-color: rgba(102, 126, 234, 0.5);
    }
    
    .contador-icon {
        font-size: 2em;
        margin-bottom: 10px;
    }
    
    .contador-valor {
        font-size: 2.5em;
        font-weight: 700;
        color: #ffffff;
        margin-bottom: 5px;
    }
    
    .contador-label {
        color: #b0b0b0;
        font-size: 0.9em;
        text-transform: uppercase;
    }
    
    /* Filtros y búsqueda */
    .filtros-estudiantes {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .btn-filtro {
        background: rgba(50, 50, 70, 0.8);
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        padding: 10px 20px;
        color: #e0e0e0;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-filtro:hover, .btn-filtro.active {
        background: rgba(102, 126, 234, 0.3);
        border-color: #667eea;
    }
    
    .search-box {
        flex: 1;
        min-width: 250px;
    }
    
    /* Observaciones */
    .observaciones-container {
        margin-top: 30px;
        padding: 25px;
        background: rgba(50, 50, 70, 0.6);
        border-radius: 15px;
        border: 2px solid rgba(102, 126, 234, 0.3);
    }
    
    .observaciones-container textarea {
        background: rgba(40, 40, 60, 0.8);
        border: 2px solid rgba(255, 255, 255, 0.1);
        color: #e0e0e0;
        resize: vertical;
        min-height: 100px;
    }
    
    .observaciones-container textarea:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        background: rgba(60, 60, 80, 0.9);
    }
    
    .observaciones-container .form-text {
        color: #a0a0a0;
        margin-top: 10px;
    }
    
    .btn-success {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border: none;
        border-radius: 15px;
        padding: 12px 30px;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(40, 167, 69, 0.5);
    }
    
    .alert {
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        border: 2px solid;
    }
    
    .alert-info {
        background: rgba(23, 162, 184, 0.2);
        color: #17a2b8;
        border-color: rgba(23, 162, 184, 0.3);
    }
    
    .alert-warning {
        background: rgba(255, 193, 7, 0.2);
        color: #ffc107;
        border-color: rgba(255, 193, 7, 0.3);
    }
    
    .alert-success {
        background: rgba(40, 167, 69, 0.2);
        color: #28a745;
        border-color: rgba(40, 167, 69, 0.3);
    }
    
    .gender-icon {
        font-size: 2.5em;
        margin-bottom: 15px;
    }
    
    .male-icon {
        color: #4fc3f7;
    }
    
    .female-icon {
        color: #f48fb1;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 15px;
        padding: 15px 40px;
        font-size: 18px;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.5);
    }
    
    .btn-secondary {
        background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
        border: none;
        border-radius: 15px;
        padding: 15px 40px;
        font-size: 18px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-secondary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(108, 117, 125, 0.5);
    }
</style>
{% endblock %}

{% block content %}
<div class="main-container">
    <div class="header">
        <h1><i class="fas fa-clipboard-check"></i> Control de Asistencias</h1>
        <p class="mb-0">Sistema de Registro Individual - UEIPAB</p>
    </div>
    
    <div class="form-section">
        <form id="asistenciaForm">
            <!-- Selección de fecha y sección -->
            <div class="row">
                <div class="col-md-6 form-group">
                    <label for="fecha" class="form-label">
                        <i class="fas fa-calendar-alt"></i> Fecha de la Clase
                    </label>
                    <input type="date" class="form-control" id="fecha" required>
                </div>
                
                <div class="col-md-6 form-group">
                    <label for="seccion" class="form-label">
                        <i class="fas fa-school"></i> Sección
                    </label>
                    <select class="form-control" id="seccion" required>
                        <option value="">Seleccione una sección...</option>
                    </select>
                </div>
            </div>
            
            <!-- Mensaje de asistencia existente -->
            <div id="alertaAsistenciaExistente" class="alert alert-warning" style="display: none;">
                <i class="fas fa-info-circle"></i> 
                <strong>Asistencia ya registrada para esta fecha y sección.</strong>
                <span id="textoAsistenciaExistente"></span>
                {% if es_admin %}
                <br><small>Puede modificar la asistencia seleccionando/deseleccionando estudiantes.</small>
                {% else %}
                <br><small class="text-danger">Solo los administradores pueden modificar asistencias registradas.</small>
                {% endif %}
            </div>
            
            <!-- Contadores de asistencia -->
            <div class="contadores-asistencia" id="contadoresAsistencia" style="display: none;">
                <div class="contador-card masculino">
                    <div class="contador-icon male-icon">
                        <i class="fas fa-male"></i>
                    </div>
                    <div class="contador-valor" id="contadorMasculinos">0</div>
                    <div class="contador-label">Masculinos</div>
                </div>
                
                <div class="contador-card femenino">
                    <div class="contador-icon female-icon">
                        <i class="fas fa-female"></i>
                    </div>
                    <div class="contador-valor" id="contadorFemeninos">0</div>
                    <div class="contador-label">Femeninos</div>
                </div>
                
                <div class="contador-card total">
                    <div class="contador-icon" style="color: #667eea;">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="contador-valor" id="contadorTotal">0</div>
                    <div class="contador-label">Total Presentes</div>
                </div>
            </div>
            
            <!-- Lista de estudiantes -->
            <div class="estudiantes-container" id="estudiantesContainer">
                <h5 class="mb-3" style="color: #e0e0e0;">
                    <i class="fas fa-list"></i> Lista de Estudiantes
                    <span id="totalEstudiantes" class="badge bg-primary ms-2">0</span>
                </h5>
                
                <!-- Filtros y búsqueda -->
                <div class="filtros-estudiantes">
                    <button type="button" class="btn-filtro active" data-filtro="todos">
                        <i class="fas fa-users"></i> Todos
                    </button>
                    <button type="button" class="btn-filtro" data-filtro="masculino">
                        <i class="fas fa-male"></i> Masculinos
                    </button>
                    <button type="button" class="btn-filtro" data-filtro="femenino">
                        <i class="fas fa-female"></i> Femeninos
                    </button>
                    <button type="button" class="btn-filtro" data-filtro="presentes">
                        <i class="fas fa-check-circle"></i> Presentes
                    </button>
                    <button type="button" class="btn-filtro" data-filtro="ausentes">
                        <i class="fas fa-times-circle"></i> Ausentes
                    </button>
                    
                    <div class="search-box">
                        <input type="text" class="form-control" id="buscarEstudiante" placeholder="Buscar por nombre o cédula...">
                    </div>
                    
                    <button type="button" class="btn btn-success" onclick="marcarTodos()">
                        <i class="fas fa-check-double"></i> Marcar Todos
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="desmarcarTodos()">
                        <i class="fas fa-times"></i> Desmarcar Todos
                    </button>
                </div>
                
                <!-- Lista de estudiantes -->
                <div id="listaEstudiantes">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-user-graduate fa-3x mb-3"></i>
                        <p>Seleccione una fecha y sección para cargar los estudiantes</p>
                    </div>
                </div>
            </div>
            
            <!-- Observaciones Generales -->
            <div class="observaciones-container" id="observacionesContainer" style="display: none;">
                <h5 class="mb-3" style="color: #e0e0e0;">
                    <i class="fas fa-clipboard"></i> Observaciones de la Clase
                </h5>
                <div class="form-group">
                    <textarea class="form-control" id="observacionesTexto" rows="4" 
                              placeholder="Escriba aquí cualquier observación o novedad que haya ocurrido durante la clase..."></textarea>
                    <small class="form-text text-muted">
                        <i class="fas fa-info-circle"></i> Las observaciones son opcionales y se guardan junto con la asistencia.
                    </small>
                </div>
            </div>
            
            <!-- Botones de acción -->
            <div class="text-center mt-4" id="botonesAccion" style="display: none;">
                <button type="submit" class="btn btn-primary me-2" id="btnGuardar">
                    <i class="fas fa-save"></i> Guardar Asistencia
                </button>
                <button type="button" class="btn btn-secondary" onclick="limpiarFormulario()">
                    <i class="fas fa-eraser"></i> Limpiar
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let estudiantesData = [];
    let asistenciaExistente = null;
    const esAdmin = {{ 'true' if es_admin else 'false' }};
    
    $(document).ready(function() {
        const today = new Date().toISOString().split('T')[0];
        $('#fecha').val(today).attr('max', today);
        
        cargarSecciones();
        
        $('#seccion').on('change', cargarEstudiantes);
        $('#fecha').on('change', cargarEstudiantes);
        $('#buscarEstudiante').on('input', filtrarEstudiantes);
        
        $('.btn-filtro').on('click', function() {
            $('.btn-filtro').removeClass('active');
            $(this).addClass('active');
            filtrarEstudiantes();
        });
        
        $('#asistenciaForm').on('submit', guardarAsistencia);
    });
    
    function cargarSecciones() {
        $.ajax({
            url: BASE_URL + '/secciones',
            method: 'GET',
            success: function(data) {
                const select = $('#seccion');
                select.empty();
                select.append('<option value="">Seleccione una sección...</option>');
                
                data.forEach(function(seccion) {
                    select.append(`<option value="${seccion.id_seccion}">${seccion.nombre_seccion}</option>`);
                });
            },
            error: function(error) {
                console.error('Error al cargar secciones:', error);
                alert('Error al cargar las secciones');
            }
        });
    }
    
    function cargarEstudiantes() {
        const fecha = $('#fecha').val();
        const seccionId = $('#seccion').val();
        
        if (!fecha || !seccionId) {
            $('#estudiantesContainer').removeClass('show');
            $('#contadoresAsistencia').hide();
            $('#botonesAccion').hide();
            return;
        }
        
        $.ajax({
            url: BASE_URL + '/api/estudiantes/seccion/' + seccionId,
            method: 'GET',
            success: function(response) {
                estudiantesData = response.estudiantes || [];
                verificarAsistenciaExistente(fecha, seccionId);
            },
            error: function(error) {
                console.error('Error al cargar estudiantes:', error);
                alert('Error al cargar los estudiantes');
            }
        });
    }
    
    function verificarAsistenciaExistente(fecha, seccionId) {
        $.ajax({
            url: BASE_URL + '/api/asistencia-individual/verificar',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ fecha: fecha, id_seccion: parseInt(seccionId) }),
            success: function(response) {
                asistenciaExistente = response.existe ? response.asistencias : null;
                
                if (response.existe) {
                    $('#alertaAsistenciaExistente').show();
                    $('#textoAsistenciaExistente').text(`${response.total_presentes} de ${estudiantesData.length} estudiantes presentes.`);
                    
                    if (!esAdmin) {
                        $('#btnGuardar').prop('disabled', true);
                        $('.estudiante-checkbox').prop('disabled', true);
                    }
                } else {
                    $('#alertaAsistenciaExistente').hide();
                    $('#btnGuardar').prop('disabled', false);
                    $('.estudiante-checkbox').prop('disabled', false);
                }
                
                mostrarEstudiantes();
                cargarObservaciones(fecha, seccionId);
            },
            error: function(error) {
                console.error('Error al verificar asistencia:', error);
                asistenciaExistente = null;
                mostrarEstudiantes();
                cargarObservaciones(fecha, seccionId);
            }
        });
    }
    
    function cargarObservaciones(fecha, seccionId) {
        $.ajax({
            url: BASE_URL + '/api/observaciones/verificar',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ fecha: fecha, id_seccion: parseInt(seccionId) }),
            success: function(response) {
                if (response.existe) {
                    $('#observacionesTexto').val(response.observaciones || '');
                } else {
                    $('#observacionesTexto').val('');
                }
                $('#observacionesContainer').show();
            },
            error: function(error) {
                console.error('Error al cargar observaciones:', error);
                $('#observacionesTexto').val('');
                $('#observacionesContainer').show();
            }
        });
    }
    
    function mostrarEstudiantes() {
        const lista = $('#listaEstudiantes');
        lista.empty();
        
        if (estudiantesData.length === 0) {
            lista.html('<div class="alert alert-info text-center"><i class="fas fa-info-circle"></i> No hay estudiantes registrados en esta sección.</div>');
            $('#estudiantesContainer').addClass('show');
            return;
        }
        
        estudiantesData.forEach(function(estudiante) {
            const generoIcono = estudiante.genero === 'M' 
                ? '<i class="fas fa-male male-icon"></i>' 
                : '<i class="fas fa-female female-icon"></i>';
            
            let presente = false;
            if (asistenciaExistente) {
                presente = asistenciaExistente.some(a => a.id_estudiante === estudiante.id_estudiante && a.presente);
            }
            
            const checkedAttr = presente ? 'checked' : '';
            const presenteClass = presente ? 'presente' : '';
            const disabledAttr = (!esAdmin && asistenciaExistente) ? 'disabled' : '';
            
            lista.append(`
                <div class="estudiante-item ${presenteClass}" data-id="${estudiante.id_estudiante}" data-genero="${estudiante.genero}">
                    <div class="estudiante-info">
                        <div class="estudiante-genero">${generoIcono}</div>
                        <div>
                            <div class="estudiante-nombre">${estudiante.nombre_completo}</div>
                            <div class="estudiante-cedula">${estudiante.cedula}</div>
                        </div>
                    </div>
                    <input type="checkbox" class="estudiante-checkbox" 
                           data-id="${estudiante.id_estudiante}" 
                           data-genero="${estudiante.genero}"
                           ${checkedAttr} ${disabledAttr}
                           onchange="actualizarContadores()">
                </div>
            `);
        });
        
        $('#totalEstudiantes').text(estudiantesData.length);
        $('#estudiantesContainer').addClass('show');
        $('#contadoresAsistencia').show();
        $('#botonesAccion').show();
        
        actualizarContadores();
        filtrarEstudiantes();
    }
    
    function actualizarContadores() {
        let masculinos = 0;
        let femeninos = 0;
        
        $('.estudiante-checkbox:checked').each(function() {
            const genero = $(this).data('genero');
            if (genero === 'M') masculinos++;
            else femeninos++;
            $(this).closest('.estudiante-item').addClass('presente');
        });
        
        $('.estudiante-checkbox:not(:checked)').each(function() {
            $(this).closest('.estudiante-item').removeClass('presente');
        });
        
        $('#contadorMasculinos').text(masculinos);
        $('#contadorFemeninos').text(femeninos);
        $('#contadorTotal').text(masculinos + femeninos);
    }
    
    function filtrarEstudiantes() {
        const filtro = $('.btn-filtro.active').data('filtro');
        const busqueda = $('#buscarEstudiante').val().toLowerCase();
        
        $('.estudiante-item').each(function() {
            const item = $(this);
            const genero = item.data('genero');
            const nombre = item.find('.estudiante-nombre').text().toLowerCase();
            const cedula = item.find('.estudiante-cedula').text().toLowerCase();
            const presente = item.find('.estudiante-checkbox').is(':checked');
            
            let mostrar = true;
            
            if (filtro === 'masculino' && genero !== 'M') mostrar = false;
            if (filtro === 'femenino' && genero !== 'F') mostrar = false;
            if (filtro === 'presentes' && !presente) mostrar = false;
            if (filtro === 'ausentes' && presente) mostrar = false;
            
            if (busqueda && !nombre.includes(busqueda) && !cedula.includes(busqueda)) {
                mostrar = false;
            }
            
            item.toggle(mostrar);
        });
    }
    
    function marcarTodos() {
        $('.estudiante-item:visible .estudiante-checkbox').prop('checked', true);
        actualizarContadores();
    }
    
    function desmarcarTodos() {
        $('.estudiante-item:visible .estudiante-checkbox').prop('checked', false);
        actualizarContadores();
    }
    
    function limpiarFormulario() {
        $('#seccion').val('');
        $('#buscarEstudiante').val('');
        $('#observacionesTexto').val('');
        $('.btn-filtro').removeClass('active').first().addClass('active');
        $('#estudiantesContainer').removeClass('show');
        $('#observacionesContainer').hide();
        $('#contadoresAsistencia').hide();
        $('#botonesAccion').hide();
        $('#alertaAsistenciaExistente').hide();
        estudiantesData = [];
        asistenciaExistente = null;
    }
    
    function guardarAsistencia(e) {
        e.preventDefault();
        
        const fecha = $('#fecha').val();
        const seccionId = parseInt($('#seccion').val());
        
        if (!fecha || !seccionId) {
            alert('Por favor seleccione fecha y sección');
            return;
        }
        
        const asistencias = [];
        $('.estudiante-checkbox').each(function() {
            asistencias.push({
                id_estudiante: parseInt($(this).data('id')),
                presente: $(this).is(':checked')
            });
        });
        
        const observaciones = $('#observacionesTexto').val().trim();
        
        const mensaje = asistenciaExistente 
            ? '¿Está seguro de actualizar la asistencia registrada?' 
            : '¿Está seguro de guardar esta asistencia?';
        
        if (!confirm(mensaje)) return;
        
        const btnGuardar = $('#btnGuardar');
        const textoOriginal = btnGuardar.html();
        btnGuardar.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Guardando...');
        
        // Guardar asistencia
        $.ajax({
            url: BASE_URL + '/api/asistencia-individual/guardar',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                fecha: fecha,
                id_seccion: seccionId,
                asistencias: asistencias
            }),
            success: function(response) {
                if (response.success) {
                    // Guardar observaciones
                    guardarObservaciones(fecha, seccionId, observaciones, function() {
                        btnGuardar.prop('disabled', false).html(textoOriginal);
                        alert('✅ Asistencia y observaciones guardadas correctamente');
                        cargarEstudiantes();
                    });
                } else {
                    btnGuardar.prop('disabled', false).html(textoOriginal);
                    alert('❌ ' + response.message);
                }
            },
            error: function(error) {
                btnGuardar.prop('disabled', false).html(textoOriginal);
                console.error('Error:', error);
                alert('Error al guardar la asistencia');
            }
        });
    }
    
    function guardarObservaciones(fecha, seccionId, observaciones, callback) {
        $.ajax({
            url: BASE_URL + '/api/observaciones/guardar',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                fecha: fecha,
                id_seccion: seccionId,
                observaciones: observaciones
            }),
            success: function(response) {
                if (callback) callback();
            },
            error: function(error) {
                console.error('Error al guardar observaciones:', error);
                if (callback) callback();
            }
        });
    }
</script>
{% endblock %}
